Class Gardevoir : PlayerPawn
{
	int RageTimer;
	int RageDelay;
	int RageConstant;
	int RageValue;
	
	bool OverTheEdge;
	
	int PunchMode;
	property PunchMode: PunchMode;
	
	property RageValue: RageValue;
	property RageDelay: RageDelay;
	
	array<Actor> HurtList;
	array<Int> HurtTracker;
	
	override void BeginPlay()
	{
		Super.BeginPlay();
		
		RageValue = 0;
		RageDelay = 35 * 3;
		Ragetimer = 0;
		RageConstant = 1000;
		
		OverTheEdge = false;
		
		PunchMode = 0;
	}
	
	void ResetTrackers() 
	{
		HurtList.clear();
		HurtTracker.clear();
		HurtTracker.resize(1024);
	}
	
	void CatharsisBonus(Actor thing) 
	{
		if (self.health <= 0) return;
		if (!thing) return;
		
		int angerBonus = Max(int(thing.spawnHealth() / 10), 1);
		
		angerBonus += HurtTracker[HurtList.find(thing)];
		HurtTracker.delete(HurtList.find(thing));
		HurtList.Delete(HurtList.find(thing));
		
		if (angerbonus >= 1 && angerBonus <= 1000 && RageValue <= 1000) {
			RageValue += Min(angerBonus, 250);
			RageValue = Min(RageConstant, RageValue);
			Console.PrintF("Anger Bonus " .. String.Format("%.1f", Min(angerBonus, 250) / 10));
			int willBonus = int(AngerBonus / 10);
			if (willBonus > 0) {
			
				let healBonus = Health(Spawn("Health"));
				healBonus.Amount = int(willBonus * 5);
				healBonus.MaxAmount = 500;
				healBonus.Touch(Self);
				Console.PrintF("Will Bonus " .. (willBonus * 5));
			}
		} else {
			if (!OverTheEdge) {
				RageValue += angerBonus;
				OverTheEdge = true;
			}
		}
	}
	
	void GetHeckingAngery() 
	{
		RageValue += 20;
		RageTimer = 0;
		if (RageValue >= RageConstant) RageValue = RageConstant;
		return;
	}
	
	void GetLivid()
	{
		RageValue += 500;
	}
	
	double GetRageValue() {
		return RageValue;
	}
	
	double GetRageModifier()
	{
		return GetRageValue() * 0.001;
	}
	
	double GetTicModifier(int tic, bool allowZero = false) 
	{
		double value = tic * (1 - GetRageModifier());
		if (!allowZero) {
			if (value < 1) value = 1;
		}
		value = round(value);
		return Max(value, 0);
	}
	
	double GetDamageModifier(double damage)
	{
		return damage + (damage * GetRageModifier());
	}
	
	double GetAccuracyModifier(double accuracy)
	{
		return min(max(1, accuracy * (1 - GetRageModifier())), 20);
	}
	
	override int DamageMobj(Actor inflictor, Actor source, int damage, Name mod, int flags = 0, double angle = 0)
	{
		if (RageValue <= RageConstant) {
			//RageValue += damage;
			RageTimer = 0;
			if (RageValue > RageConstant) RageValue = RageConstant;
		}
		
		HurtList.push(source);
		HurtTracker[HurtList.find(source)] += damage;
		
		return Super.DamageMobj(inflictor, source, damage, mod, flags, angle);
	}
	
	override void Tick()
	{
		Super.Tick();
		
		RageTimer++;
		
		if (OverTheEdge && RageValue <= RageConstant) OverTheEdge = false;
		
		if (RageValue > 0 && RageValue <= RageConstant) {
			int delay = 35 * GetRageModifier();
			if (RageTimer > RageDelay) {
				RageValue--;
				RageDelay -= 2;
				if (RageDelay < 35) RageDelay = 35;
				RageTimer = 0;
			}
		} else if (RageValue > RageConstant) {
			int angercap = RageValue / RageConstant;
			if (RageTimer > 5) {
				RageValue -= (2 * angercap);
				RageTimer = 0;
			}
		}
		
		//A_Print("" .. RageValue .. ":" .. GetRageModifier());
	}	
	
	default {
		Health 350;
        Player.DisplayName "Gardevoir" ;
		Player.StartItem "GHAGPistol";
		Player.StartItem "ElementPunch";
		Player.StartItem "Clip", 50;
		Player.MaxHealth 350;
     }
}